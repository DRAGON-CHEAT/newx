<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DraGon-News</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <style>
    :root {
      --A-Color: #000000;
      --B-Color: #0a111e;
      --bg: var(--A-Color);
      --bg-2: #0f1520;
      --card: #121928;
      --Primary-A-Color: #ff8a00;
      --accent: var(--Primary-A-Color);
      --text: #e8ecf3;
      --Primary-B-Color: var(--text); 
      --Primary-C-Color: #97a3b6;
      --muted: var(--Primary-C-Color);
      --Primary-D-Color: #1a2335;
      --top-nav-height: 50px;
      --sub-nav-height: 48px;
    }

    /* Dark Mode Theme */
    html[data-theme='light'] {
      --A-Color: #ffffff;
      --B-Color: #f0f2f5;
      --bg: var(--B-Color);
      --bg-2: #ffffff;
      --card: #ffffff;
      --text: #1a1a1a;
      --Primary-B-Color: var(--text); 
      --Primary-C-Color: #6c757d;
      --Primary-D-Color: #dee2e6;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html { scroll-behavior: smooth; } /* تحسين 10 */
    body { 
      margin: 0; 
      font-family: "Tajawal", sans-serif; 
      background-color: var(--bg); 
      color: var(--text); 
      -webkit-font-smoothing: antialiased; 
      -moz-osx-font-smoothing: grayscale; 
      padding-bottom: env(safe-area-inset-bottom); 
      /* حل مشكلة المسافة السوداء: اعتماد البادينج على الشريط العلوي فقط */
      padding-top: var(--top-nav-height); 
    }
    a { text-decoration: none; color: inherit; }
    a:hover { opacity: 0.85; }

    .top-navbar-container {
      position: fixed; top: 0; right: 0; left: 0; z-index: 1000;
      background-color: var(--A-Color);
      backdrop-filter: blur(10px); /* تحسين 3: تأثير زجاجي */
      -webkit-backdrop-filter: blur(10px);
    }
    .top-navbar {
      height: var(--top-nav-height); display: flex; justify-content: space-between;
      align-items: center; padding: 0 15px; border-bottom: 1px solid var(--Primary-D-Color);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .sidebar-toggle-container { display: flex; align-items: center; gap: 10px; }
    .sidebar-icon, .share-icon, .refresh-icon, .search-icon, .theme-toggle-icon { /* تحسين 2, 5 */
        font-size: 24px; color: var(--Primary-B-Color); cursor: pointer; 
        transition: transform 0.2s ease;
    }
    .top-navbar-icons-right { display: flex; align-items: center; gap: 15px; }
    .navbar-logo-link { display: flex; align-items: center; text-decoration: none; }
    .logo-img-small { width: 32px; height: 32px; border-radius: 50%; }
    .logo-text { font-weight: 700; font-size: 1.2rem; color: var(--Primary-B-Color); margin-left: 5px; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5); }

    .sub-navbar {
        position: sticky; top: var(--top-nav-height); z-index: 990; /* تثبيت الشريط الفرعي */
        width: 100%; height: var(--sub-nav-height); background-color: var(--A-Color);
        border-bottom: 1px solid var(--Primary-D-Color); display: flex; align-items: center;
        padding: 0 15px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); overflow-x: auto;
        -webkit-overflow-scrolling: touch; white-space: nowrap;
    }
    /* تم تغيير الـ body padding-top ليناسب الشريطين الثابت والـ Sticky */
    body { padding-top: calc(var(--top-nav-height) + var(--sub-nav-height)); } 

    .sub-navbar::-webkit-scrollbar { height: 4px; }
    .sub-navbar::-webkit-scrollbar-thumb { background-color: var(--Primary-A-Color); border-radius: 2px; }
    .sub-navbar-link {
        color: var(--Primary-C-Color); font-size: 15px; font-weight: 500;
        padding: 8px 15px; transition: color 0.3s ease; position: relative; text-decoration: none;
    }
    .sub-navbar-link.active { color: var(--Primary-B-Color); font-weight: 700; }
    .sub-navbar-link.active::after {
        content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%) scaleX(0);
        width: 100%; height: 2px; background-color: var(--Primary-A-Color); animation: underline 0.3s forwards;
    }
    @keyframes underline { from { transform: translateX(-50%) scaleX(0); } to { transform: translateX(-50%) scaleX(1); } }

    .bottom-navbar {
        position: fixed; bottom: 0; left: 0; right: 0; z-index: 1000;
        height: 56px; 
        background-color: var(--B-Color); border-top: 1px solid var(--Primary-D-Color);
        box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.2); display: flex;
        justify-content: space-around; align-items: center; padding: 0 5px;
    }
    .bottom-navbar-link {
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        flex: 1; height: 100%; color: var(--Primary-C-Color); font-size: 12px;
        font-weight: 500; transition: color 0.3s ease, transform 0.1s ease; text-decoration: none;
    }
    .bottom-navbar-link:active { transform: scale(0.95); } /* تحسين 7 */
    .bottom-navbar-link i { font-size: 18px; margin-bottom: 3px; }
    .bottom-navbar-link.active { color: var(--Primary-A-Color); font-weight: 700; }
    
    .sidebar-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.6); z-index: 1050; visibility: hidden;
      opacity: 0; transition: visibility 0.3s, opacity 0.3s;
    }
    .sidebar-overlay.active { visibility: visible; opacity: 1; }
    .sidebar {
      position: fixed; top: 0; right: -250px; width: 230px; height: 100%;
      background: var(--bg-2); box-shadow: -2px 0 10px rgba(0, 0, 0, 0.3);
      z-index: 1100; transition: right 0.3s ease-in-out; display: flex;
      flex-direction: column;
    }
    .sidebar.active { right: 0; }
    .sidebar-header { padding: 15px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid var(--Primary-D-Color); }
    .sidebar-header img { width: 40px; height: 40px; border-radius: 50%; }
    .sidebar-header h2 { margin: 0; font-size: 1.3rem; color: var(--accent); }
    .sidebar-menu { list-style: none; padding: 0; margin: 0; flex-grow: 1; }
    .sidebar-menu-item { padding: 12px 15px; transition: background-color 0.2s ease; }
    .sidebar-menu-item:hover { background-color: var(--card); }
    .sidebar-menu-item a { display: flex; align-items: center; gap: 12px; color: var(--text); text-decoration: none; font-weight: 600; font-size: 1rem; }
    .sidebar-menu-item i { font-size: 1.2rem; width: 20px; text-align: center; }

    .Goal-X-news-header { 
      position: relative; width: 100%; 
      height: 220px; 
      overflow: hidden; background: linear-gradient(135deg, var(--bg-2) 0%, var(--card) 100%); 
      border-bottom: 1px solid var(--Primary-D-Color); 
    }
    .news-slider { position: relative; width: 100%; height: 100%; }
    .news-slide { 
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
      display: flex; align-items: flex-end; padding: 0 16px 30px; 
      background-size: cover; background-position: center; 
      cursor: pointer; z-index: 1; transition: opacity 0.8s ease;
    }
    .news-slide:not(.active) { opacity: 0; }
    .news-slide.active { opacity: 1; z-index: 2; }
    .news-slide::before { 
      content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
      background: linear-gradient(to top, rgba(0,0,0,0.85) 0%, rgba(0,0,0,0.4) 50%, rgba(0,0,0,0.2) 100%); 
      z-index: -1; 
    }
    .news-content { width: 100%; padding-bottom: 0; }
    .news-title { 
      font-size: 1.2rem; font-weight: 700; margin: 0 0 8px; color: var(--text); 
      line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; 
      -webkit-box-orient: vertical; overflow: hidden; text-shadow: 0 2px 4px rgba(0,0,0,0.5); 
    }
    .news-time { font-size: 0.85rem; color: var(--accent); margin: 0; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
    .news-indicators { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 8px; z-index: 3; }
    .news-indicator { width: 8px; height: 8px; border-radius: 50%; background: var(--muted); cursor: pointer; transition: all 0.3s ease; }
    .news-indicator.active { background: var(--accent); transform: scale(1.2); }
    
    main { padding: 16px 12px; max-width: 1100px; margin: 0 auto; }

    /* تحسين 2: قسم الأخبار المميزة الأفقي */
    .Goal-X-featured-news {
        display: flex; overflow-x: auto; gap: 10px; padding-bottom: 15px;
        scroll-snap-type: x mandatory; /* تحسين 4: تمرير سلس */
        -webkit-overflow-scrolling: touch;
        margin-bottom: 20px;
    }
    .Goal-X-featured-news::-webkit-scrollbar { height: 0; }
    .Goal-X-featured-card {
        flex-shrink: 0; width: 80vw; max-width: 300px; height: 180px; 
        background: var(--card); border-radius: 12px; overflow: hidden;
        box-shadow: 0 4px 12px rgba(2, 6, 12, 0.3); position: relative;
        scroll-snap-align: start; /* تحسين 4 */
    }
    .Goal-X-featured-card .image { 
        width: 100%; height: 100%; background-size: cover; background-position: center;
    }
    .Goal-X-featured-card .overlay {
        position: absolute; bottom: 0; left: 0; right: 0; padding: 15px;
        background: linear-gradient(to top, rgba(0,0,0,0.9), rgba(0,0,0,0));
    }
    .Goal-X-featured-card .title {
        font-size: 1rem; font-weight: 600; margin: 0; color: var(--text);
        display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
    }

    .Goal-X-section-title { display: flex; justify-content: space-between; align-items: center; gap: 12px; margin-bottom: 16px; padding: 0 4px; }
    .Goal-X-section-title h2 { margin: 0; font-size: 1.1rem; font-weight: 700; }
    .Goal-X-section-title .note { color: var(--muted); font-size: 0.75rem; }
    .Goal-X-news-vertical { display: flex; flex-direction: column; gap: 12px; }
    
    .Goal-X-card-vertical { 
      background: var(--card); border-radius: 12px; overflow: hidden; 
      box-shadow: 0 4px 12px rgba(2, 6, 12, 0.4); position: relative; height: 110px; 
      display: flex; align-items: center; transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease; 
    }
    .Goal-X-card-vertical:hover { background-color: var(--bg-2); }
    .Goal-X-card-vertical:active { transform: scale(0.98); }
    .Goal-X-card-vertical .image { 
      width: 100px; height: 100px; margin: 5px; background-size: cover; 
      background-position: center; border-radius: 8px; flex-shrink: 0; 
      position: relative; overflow: hidden; 
    }
    .Goal-X-card-vertical .content { 
      padding: 10px 12px 10px 5px; display: flex; flex-direction: column; 
      justify-content: space-between; flex-grow: 1; height: 100%; 
    }
    .Goal-X-card-vertical .title { 
      font-weight: 600; font-size: 1.1rem; line-height: 1.35; color: var(--text); 
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; 
      overflow: hidden; margin: 0; 
    }
    .Goal-X-card-vertical .meta { 
      display: flex; justify-content: space-between; align-items: center; gap: 8px; 
      color: var(--muted); font-size: 0.9rem; margin-top: auto; 
    }
    .Goal-X-card-vertical .read-more-icon { /* تحسين 6 */
        color: var(--Primary-A-Color); font-size: 0.8rem; transform: rotate(180deg);
        transition: transform 0.2s ease;
    }
    .Goal-X-card-vertical a:hover .read-more-icon { transform: rotate(180deg) scale(1.1); }

    .Goal-X-card-vertical a { color: inherit; text-decoration: none; display: flex; align-items: center; width: 100%; height: 100%; }
    
    .Goal-X-load-more-wrap { text-align: center; margin-top: 20px; margin-bottom: 30px; padding: 0 8px; }
    .Goal-X-btn-more { 
      display: inline-block; padding: 12px 24px; border-radius: 10px; 
      background: linear-gradient(90deg, var(--accent), #7b45ff); color: white; 
      font-weight: 700; font-size: 0.9rem; border: none; cursor: pointer; 
      box-shadow: 0 5px 15px rgba(155, 97, 255, 0.2); transition: all 0.2s ease; 
      width: 100%; max-width: 280px; 
    }
    .Goal-X-btn-more:active { transform: translateY(1px); box-shadow: 0 3px 10px rgba(155, 97, 255, 0.15); }
    
    .offline-notice { /* تحسين 8 */
        background: var(--card); border: 2px solid var(--Primary-A-Color); 
        border-radius: 12px; padding: 15px; margin: 15px 8px; 
        text-align: center; font-size: 0.9rem; color: var(--text); line-height: 1.5; 
        display: flex; align-items: center; justify-content: center; gap: 10px;
    }
    .offline-notice i { color: var(--Primary-A-Color); font-size: 1.2rem; }
    
    /* Smart Update Indicator */
    .smart-update-indicator {
      width: 6px; height: 6px; background-color: var(--Primary-A-Color);
      border-radius: 50%; opacity: 0; transition: opacity 0.3s ease;
      animation: pulse 1s infinite;
    }
    .smart-update-indicator.active { opacity: 1; }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.4); }
    }

    @media (max-width: 360px) { 
      .Goal-X-news-header { height: 180px; } 
      .news-title { font-size: 1rem; } 
      .Goal-X-card-vertical { height: 90px; } 
      .Goal-X-card-vertical .image { width: 80px; height: 80px; } 
      .Goal-X-card-vertical .title { font-size: 0.95rem; } 
      .Goal-X-card-vertical .meta { font-size: 0.8rem; } 
    }
    @media (min-width: 768px) { 
      main { padding: 20px 16px; } 
      .Goal-X-news-vertical { gap: 16px; } 
    }
    @media (max-width: 640px) and (orientation: landscape) { 
      .Goal-X-news-header { height: 200px; } 
      .news-slide { align-items: center; padding: 0 20px; } 
      .news-content { max-width: 70%; } 
    }
    @supports (padding: max(0px)) { body { padding-left: max(12px, env(safe-area-inset-left)); padding-right: max(12px, env(safe-area-inset-right)); } }
    @media (hover: none) { 
      .Goal-X-card-vertical:hover { transform: none; box-shadow: 0 4px 12px rgba(2, 6, 12, 0.4); background-color: var(--card); } 
      .Goal-X-btn-more:hover { transform: none; box-shadow: 0 5px 15px rgba(155, 97, 255, 0.2); } 
    }
    @media (pointer: coarse) { 
      .news-indicator { width: 10px; } 
      .Goal-X-btn-more { padding: 14px 24px; } 
    }
    @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) { 
      .Goal-X-card-vertical { border-radius: 14px; } 
      .Goal-X-card-vertical .image { border-radius: 10px; } 
    }
  </style>
</head>
<body>

  <div class="top-navbar-container" id="top-navbar-container">
        <div class="top-navbar">
            <div class="sidebar-toggle-container">
                <i class="fas fa-arrow-right back-button-icon" id="back-button" onclick="goBack()" style="display:none;"></i> 

                <a href="/" class="navbar-logo-link">
                    
                </a>
                <span class="logo-text" style="color:#ff8c00; user-select:none; font-size:18px;">⚽️DraGonTv</span>

            </div>
            <div class="top-navbar-icons-right">
                <i class="fas fa-sun theme-toggle-icon" id="theme-toggle" title="وضع الألوان"></i> <i class="fas fa-sync-alt refresh-icon" id="refresh-icon" title="تحديث"></i>
                
            </div>
        </div>
  </div>

<!-- قسم مباريات كرة القدم -->
<div class="matches-wrapper">
  <div class="buttons">
    <button onclick="fetchMatches('today')">مباريات اليوم</button>
    <button onclick="fetchMatches('yesterday')">مباريات الأمس</button>
  </div>
  <div class="matches-container" id="matchesContainer">
    <div style="color:var(--muted);padding:20px;text-align:center;">جارٍ تحميل المباريات...</div>
  </div>
  </div>


  <header class="Goal-X-news-header" id="newsHeader">
    <div class="news-slider" id="newsSlider">
      <div style="color:var(--text);padding:30px 20px; text-align:center">جاري تحميل الأخبار العاجلة...</div>
    </div>
    <div class="news-indicators" id="newsIndicators"></div>
  </header>

  <main>
    <div class="Goal-X-section-title" id="featured-section">
        <h2>الأخبار المميزة:</h2>
        <div class="note">أهم الأحداث حاليًا</div>
    </div>
    <div class="Goal-X-featured-news" id="featuredNewsRow">
        <div style="color:var(--muted);padding:10px; text-align:center; flex-shrink: 0; width: 100%;">جارٍ تحميل الأخبار المميزة...</div>
        </div>
    
    <div class="Goal-X-section-title" id="latest-news">
      <h2>آخر الأخبار:</h2>
      <div class="note">ترتيب حسب الحدث الزمني</div>
    </div>

    <div id="offlineNotice" class="offline-notice" style="display: none;">
        <i class="fas fa-exclamation-triangle"></i>
        <span>وضع عدم الاتصال مفعل.</span>
    </div>

    <div class="Goal-X-news-vertical" id="newsRow" aria-live="polite">
      <div style="color:var(--muted);padding:30px 10px; text-align:center">جارٍ تحميل الأخبار...</div>
    </div>

    
    <div class="Goal-X-load-more-wrap">
      <button id="moreBtn" class="Goal-X-btn-more">عرض المزيد</button>
    </div>
    
  </main>

  <script>
    //  تغيير 1: تحديث الرابط الأساسي لاستخدام البروكسي والـ API الجديد
const BASE_URL = 'https://proxy.goalx.workers.dev/?url=https://app.fanlive.org/news.php?type=main';
let allNews = [];
let currentSlide = 0;
let slideInterval;

async function fetchNewsData() {
    // إضافة باراميتر عشوائي لمنع الكاش
    const url = `${BASE_URL}&_=${Date.now()}`;
    const response = await fetch(url);
    if (!response.ok) throw new Error(`خطأ في الاستجابة: ${response.status}`);
    const data = await response.json();
    return data;
}

// تحميل أولي عند فتح الموقع
window.addEventListener('load', () => {
    const refreshIcon = document.getElementById('refresh-icon');

    if (navigator.onLine) {
        // الدوران التلقائي عند وجود الإنترنت
        refreshIcon.classList.add('fa-spin');
        loadInitial(true).finally(() => {
            refreshIcon.classList.remove('fa-spin');
        });
    } else {
        // لا يوجد إنترنت → تحميل من الكاش بدون دوران
        loadInitial(false);
    }
});


// تحسين 2: دالة عرض الأخبار المميزة
function appendFeaturedNews(arr) {
    const container = document.getElementById('featuredNewsRow');
    const featured = arr.slice(5, 10); // عرض 5 أخبار تالية كـ "مميزة"

    if (featured.length === 0) {
        container.innerHTML = '<div style="color:var(--muted);padding:10px; text-align:center; flex-shrink: 0; width: 100%;">لا توجد أخبار مميزة حاليًا.</div>';
        return;
    }

    container.innerHTML = '';
    featured.forEach((item, index) => {
        const card = document.createElement('div');
        card.className = 'Goal-X-featured-card';
        const fullIndex = allNews.findIndex(n => n.title === item.title && n.date === item.date);
        const linkHref = fullIndex !== -1 ? `detail.html?index=${fullIndex}` : '#';

        card.innerHTML = `
    <div class="image" style="background-image: url('${item.image || 'https://images.unsplash.com/photo-1541534741688-6040854896de?fit=crop&w=300&h=180&q=80'}')"></div>
    <div class="overlay">
        <h3 class="title">${item.title || 'بدون عنوان'}</h3>
    </div>
`;

// عند الضغط على البطاقة، فتح المودال بدل الانتقال
card.addEventListener('click', () => openNewsModal(item));

        container.appendChild(card);
    });
}

function appendNews(arr) {
    const container = document.getElementById('newsRow');
    if (!Array.isArray(arr) || arr.length === 0) {
        if (container.children.length === 0 || container.children[0].textContent.includes('جارٍ')) {
            container.innerHTML = '<div style="color:var(--muted);padding:20px; text-align:center">لا توجد أخبار حاليًا.</div>';
        }
        return;
    }

    if (container.children.length && container.children[0].textContent.includes('جارٍ')) {
        container.innerHTML = '';
    }

    arr.forEach((item) => {
        const card = document.createElement('div');
        card.className = 'Goal-X-card-vertical';
        const fullIndex = allNews.findIndex(n => n.title === item.title && n.date === item.date);
        const linkHref = fullIndex !== -1 ? `detail.html?index=${fullIndex}` : '#';

        card.innerHTML = `
    <div class="image" style="background-image: url('${item.image || 'https://images.unsplash.com/photo-1541534741688-6040854896de?fit=crop&w=300&h=180&q=80'}')"></div>
    <div class="overlay">
        <h3 class="title">${item.title || 'بدون عنوان'}</h3>
    </div>
`;

// عند الضغط على البطاقة، فتح المودال بدل الانتقال
card.addEventListener('click', () => openNewsModal(item));

        container.appendChild(card);
    });

    if (allNews.length > 0) {
        document.getElementById('moreBtn').style.display = 'none';
    }
}

function createNewsSlider(newsItems) {
    const slider = document.getElementById('newsSlider');
    const indicatorsContainer = document.getElementById('newsIndicators');

    if (!newsItems || newsItems.length === 0) {
        slider.innerHTML = `<div class="news-slide active"><div class="news-content"><h2 class="news-title">DraGon-News</h2><p class="news-time">كل جديد في عالم كرة القدم</p></div></div>`;
        indicatorsContainer.innerHTML = '';
        return;
    }

    const top5News = newsItems.slice(0, 5);
    slider.innerHTML = '';
    indicatorsContainer.innerHTML = '';
    currentSlide = 0;

    top5News.forEach((news, index) => {
        const slide = document.createElement('div');
        slide.className = `news-slide ${index === 0 ? 'active' : ''}`;
        slide.style.backgroundImage = `url('${news.image || 'https://images.unsplash.com/photo-1461896836934-ffe607ba8211?fit=crop&w=200&q=80'}')`;
        slide.innerHTML = `<div class="news-content"><h2 class="news-title">${news.title || 'بدون عنوان'}</h2><p class="news-time">${news.date || ''}</p></div>`;

        slide.addEventListener('click', () => openNewsModal(news));

        slider.appendChild(slide);

        const indicator = document.createElement('div');
        indicator.className = `news-indicator ${index === 0 ? 'active' : ''}`;
        indicator.dataset.index = index;
        indicator.addEventListener('click', () => { goToSlide(index); });
        indicatorsContainer.appendChild(indicator);
    });
    startSlider();
}

function startSlider() {
    clearInterval(slideInterval);
    slideInterval = setInterval(() => { nextSlide(); }, 3000);
}

function nextSlide() {
    const slides = document.querySelectorAll('.news-slide');
    if (slides.length === 0) return;
    const indicators = document.querySelectorAll('.news-indicator');
    slides[currentSlide].classList.remove('active');
    indicators[currentSlide].classList.remove('active');
    currentSlide = (currentSlide + 1) % slides.length;
    slides[currentSlide].classList.add('active');
    indicators[currentSlide].classList.add('active');
}

function goToSlide(index) {
    const slides = document.querySelectorAll('.news-slide');
    if (slides.length === 0 || index === currentSlide) return;
    const indicators = document.querySelectorAll('.news-indicator');
    slides[currentSlide].classList.remove('active');
    indicators[currentSlide].classList.remove('active');
    currentSlide = index;
    slides[currentSlide].classList.add('active');
    indicators[currentSlide].classList.add('active');
    startSlider();
}

async function loadInitial(manualRefresh = false) {
    const container = document.getElementById('newsRow');
    const featuredContainer = document.getElementById('featuredNewsRow');
    const moreBtn = document.getElementById('moreBtn');
    const offlineNotice = document.getElementById('offlineNotice');
    const refreshIcon = document.getElementById('refresh-icon');

    if (manualRefresh) {
        refreshIcon.classList.add('fa-spin');
    }

    let cachedData = localStorage.getItem('allNewsCache');

    if (!manualRefresh && cachedData) {
        try {
            allNews = JSON.parse(cachedData);
            appendNews(allNews);
            createNewsSlider(allNews);
            appendFeaturedNews(allNews); // تحديث المميزة
        } catch (e) {
            localStorage.removeItem('allNewsCache');
        }
    } else {
        container.innerHTML = '<div style="color:var(--muted);padding:30px 10px; text-align:center">جارٍ تحميل الأخبار...</div>';
        featuredContainer.innerHTML = '<div style="color:var(--muted);padding:10px; text-align:center; flex-shrink: 0; width: 100%;">جارٍ تحميل الأخبار المميزة...</div>';
    }

    offlineNotice.style.display = 'none';
    moreBtn.style.display = 'block';

    try {
    const data = await fetchNewsData();

    allNews = Array.isArray(data) ? data : [];
    // حفظ نسخة الكاش
    localStorage.setItem('allNewsCache', JSON.stringify(allNews));

    // تحديث الواجهة
    appendNews(allNews);
    appendFeaturedNews(allNews);
    createNewsSlider(allNews);

    offlineNotice.style.display = 'none';
    moreBtn.style.display = 'none';

} catch (err) {
    console.warn('خطأ في التحميل، سيتم استخدام النسخة المخزنة إذا وجدت', err);

    // محاولة استرجاع النسخة المخزنة
    const cachedData = localStorage.getItem('allNewsCache');
    if (cachedData) {
        allNews = JSON.parse(cachedData);

        appendNews(allNews);
        appendFeaturedNews(allNews);
        createNewsSlider(allNews);

        offlineNotice.style.display = 'flex'; // فقط لإظهار الرسالة
        moreBtn.style.display = 'none';
    } else {
        // لا توجد نسخة مخزنة
        document.getElementById('newsRow').innerHTML = `<div style="color:var(--muted);padding:20px;text-align:center">لا توجد بيانات سابقة متاحة لعرضها.</div>`;
        document.getElementById('featuredNewsRow').innerHTML = `<div style="color:var(--muted);padding:10px;text-align:center;width:100%;">لا يمكن تحميل الأخبار المميزة حاليًا.</div>`;
        offlineNotice.style.display = 'flex';
        moreBtn.style.display = 'none';
    }
}

}

function loadMore() {
    const btn = document.getElementById('moreBtn');
    btn.textContent = 'تم تحميل جميع الأخبار';
    btn.disabled = true;
    setTimeout(() => {
        btn.style.display = 'none';
    }, 1500);
}

// تحسين 1: منطق الوضع الداكن/الفاتح
const themeToggle = document.getElementById('theme-toggle');
const savedTheme = localStorage.getItem('goalx-theme');

if (savedTheme) {
    document.documentElement.setAttribute('data-theme', savedTheme);
    themeToggle.className = savedTheme === 'light' ? 'fas fa-moon theme-toggle-icon' : 'fas fa-sun theme-toggle-icon';
} else {
    // الافتراضي داكن
    document.documentElement.setAttribute('data-theme', 'dark');
    themeToggle.className = 'fas fa-sun theme-toggle-icon';
}

themeToggle.addEventListener('click', () => {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', newTheme);
    localStorage.setItem('goalx-theme', newTheme);
    themeToggle.className = newTheme === 'light' ? 'fas fa-moon theme-toggle-icon' : 'fas fa-sun theme-toggle-icon';
});


document.getElementById('moreBtn').addEventListener('click', loadMore);
document.getElementById('refresh-icon').addEventListener('click', () => {
    if (!navigator.onLine) return; // إذا لا يوجد نت، لا يدور ولا يحمل
    const refreshIcon = document.getElementById('refresh-icon');
    refreshIcon.classList.add('fa-spin');
    loadInitial(true).finally(() => {
        refreshIcon.classList.remove('fa-spin');
    });
});


let touchStartX = 0;
let touchEndX = 0;
const sliderContainer = document.getElementById('newsSlider');
sliderContainer.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; }, false);
sliderContainer.addEventListener('touchend', e => { touchEndX = e.changedTouches[0].screenX; handleSwipe(); }, false);

function handleSwipe() {
    const minSwipeDistance = 50;
    const slides = document.querySelectorAll('.news-slide');
    if (slides.length === 0) return;

    if (touchStartX - touchEndX > minSwipeDistance) {
        nextSlide();
    } else if (touchEndX - touchStartX > minSwipeDistance) {
        const indicators = document.querySelectorAll('.news-indicator');
        slides[currentSlide].classList.remove('active');
        indicators[currentSlide].classList.remove('active');
        currentSlide = (currentSlide - 1 + slides.length) % slides.length;
        slides[currentSlide].classList.add('active');
        indicators[currentSlide].classList.add('active');
        startSlider();
    }
}

const sidebarIcon = document.getElementById('sidebar-icon');
const sidebar = document.getElementById('sidebar');
const sidebarOverlay = document.getElementById('sidebar-overlay');

sidebarIcon.addEventListener('click', () => {
    sidebar.classList.add('active');
    sidebarOverlay.classList.add('active');
});

sidebarOverlay.addEventListener('click', () => {
    sidebar.classList.remove('active');
    sidebarOverlay.classList.remove('active');
});

// 
loadInitial();

// دوال المودال
function openNewsModal(item) {
    const modal = document.getElementById('newsModal');
    modal.style.display = 'flex';

    const contentDiv = document.getElementById('newsContentText');
    const closeBtn = document.getElementById('closeNewsBtn');

    // العنوان
    document.getElementById('modalTitle').textContent = item.title || 'بدون عنوان';

    // زر الإغلاق
    closeBtn.style.padding = '4px 8px';
    closeBtn.style.fontSize = '14px';
    closeBtn.onclick = () => { modal.style.display = 'none'; };

    // التعامل مع نص الخبر
    const cachedData = JSON.parse(localStorage.getItem('allNewsCache') || '[]');

    if (item.txt && item.txt.trim() !== '') {
        // النص موجود مسبقًا → عرض وتحديث الكاش
        let text = item.txt
            .replace(/\{/g, '')            
            .replace(/"date":\s*"/g, '*')  
            .replace(/"txt":\s*"/g, '#')   
            .replace(/"$/,'')              
            .replace(/\\n|\/n|\n/g, '<br>'); 
        contentDiv.innerHTML = text;

        // تحديث الكاش فورًا
        const updatedCache = cachedData.map(n => {
            if (n.title === item.title && n.date === item.date) {
                return { ...n, txt: item.txt };
            }
            return n;
        });
        localStorage.setItem('allNewsCache', JSON.stringify(updatedCache));

    } else if (item.link && navigator.onLine) {
        // الإنترنت شغال → جلب النص من الرابط
        fetch(`https://proxy.goalx.workers.dev/?url=${encodeURIComponent(item.link)}`)
            .then(r => r.text())
            .then(html => {
                let cleanText = html
                    .replace(/\{/g, '⚽')
                    .replace(/"date":\s*"/g, '"')
                    .replace(/"txt":\s*"/g, '#')
                    .replace(/"$/,'')
                    .replace(/\\n|\/n|\n/g, '<br>');
                contentDiv.innerHTML = cleanText;

                // حفظ النص في الكاش
                const updatedCache = cachedData.map(n => {
                    if (n.title === item.title && n.date === item.date) {
                        return { ...n, txt: cleanText };
                    }
                    return n;
                });
                localStorage.setItem('allNewsCache', JSON.stringify(updatedCache));
            })
            .catch(() => { contentDiv.innerHTML = "تعذر تحميل تفاصيل الخبر."; });

    } else {
        // الإنترنت مقطوع → جلب النص من الكاش
        const cachedItem = cachedData.find(n => n.title === item.title && n.date === item.date);
        if (cachedItem && cachedItem.txt) {
            contentDiv.innerHTML = cachedItem.txt.replace(/\n/g, '<br>');
        } else {
            contentDiv.innerHTML = "لا توجد تفاصيل محفوظة للخبر .";
        }
    }
}

// حفظ البيانات في localStorage
function saveCache(data) {
    try {
        localStorage.setItem('cachedNews', JSON.stringify(data));
        localStorage.setItem('cacheTime', Date.now());
    } catch (e) {
        console.warn("Cache save error:", e);
    }
}

// استرجاع البيانات المخزنة
function loadCache() {
    const data = localStorage.getItem('cachedNews');
    if (!data) return null;
    try {
        return JSON.parse(data);
    } catch {
        return null;
    }
}



  </script>
  
<div id="newsModal" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:none;justify-content:center;align-items:center;z-index:9999;">
  <div style="background:#1a1a1a;color:#fff;width:90%;max-height:85%;overflow-y:auto;padding:20px;border-radius:12px;direction:rtl;position:relative;">
      <!-- زر الإغلاق -->
      <button id="closeNewsBtn" style="position:absolute;top:5px;left:10px;background:red;color:white;padding:6px 10px;border-radius:6px;border:none;font-size:12px;">إغلاق ✖</button>

      <!-- العنوان -->
      <h2 id="modalTitle" style="margin-bottom:8px;font-weight:bold;"></h2>
      <!-- التاريخ -->
      <h3 id="modalDate" style="margin-bottom:12px;font-weight:bold;"></h3>
      <!-- النص الرئيسي -->
      <div id="newsContentText" style="line-height:1.8;font-size:18px;"></div>
  </div>
</div>

<!-- Powered By DragonApps Footer -->
<div class="dragon-footer">
  <a href="https://t.me/android2AppModedxApk" target="_blank">
    ☄ Powered by DragonApps
  </a>
</div>

<script>
const matchesContainer = document.getElementById('matchesContainer');
let currentDay = 'today';
let refreshInterval;

// دالة تسجيل الأخطاء آمنة بدون عنصر log
function logError(message) {
  console.warn(message); // سيعرض الخطأ في الـ Console بدل العنصر
}


async function fetchMatches(day) {
  currentDay = day;
  if(refreshInterval) clearInterval(refreshInterval);

  matchesContainer.innerHTML = '<div style="text-align:center;color:var(--muted);padding:20px;">جارٍ التحميل...</div>';

  const today = new Date();
  let date = day === 'today' ? today.toISOString().split('T')[0]
                             : new Date(today.setDate(today.getDate()-1)).toISOString().split('T')[0];

  const url = `https://proxy.goalx.workers.dev/?url=https%3A%2F%2Fwww.yalla-shoot-365.com%2Fmatches%2Fnpm%2F%3Fdate%3D${date}%26lang%3D27%26time%3D%2B03%3A00`;

  try {
    const res = await fetch(url);
    if(!res.ok) throw new Error(`خطأ في الاتصال: ${res.status}`);
    const data = await res.json();
    renderMatches(data['STING-WEB-Matches'] || []);
    if(day === 'today') refreshInterval = setInterval(() => fetchMatches('today'), 30000);
  } catch (err) {
    matchesContainer.innerHTML = '<div style="text-align:center;color:var(--muted);padding:20px;">حدث خطأ أثناء جلب المباريات.</div>';
    logError(err.message);
  }
}

function renderMatches(matches) {
  matchesContainer.innerHTML = '';
  if(matches.length === 0) {
    matchesContainer.innerHTML = '<div style="text-align:center;color:var(--muted);padding:20px;">لا توجد مباريات.</div>';
    return;
  }

  matches.forEach(match => {
    const card = document.createElement('div');
    card.className = 'match-card';
    function shortenName(name, maxLength = 8) {
  return name.length > maxLength ? name.substring(0, maxLength) + '..' : name;
}

const leftTeamName = shortenName(match['Team-Left'].Name);
const rightTeamName = shortenName(match['Team-Right'].Name);

    const leftScore = match['Team-Left'].Goal || 0;
    const rightScore = match['Team-Right'].Goal || 0;
    let scoreContent = (currentDay==='today' && (match['Match-Status']==='Playing'||leftScore+rightScore>0)) 
                        ? `<span class="blinking">${leftScore} - ${rightScore}</span>` 
                        : `${leftScore} - ${rightScore}`;
    if(match['Match-Status']==='NotStarted') scoreContent = 'VS';

    card.innerHTML = `
      <div class="league-name">${match['Cup-Name']}</div>
      <div class="teams">
        <div class="team">
          <img src="https://www.yalla-shoot-365.com${match['Team-Left'].Logo}" alt="${leftTeamName}">
          <span>${leftTeamName}</span>
        </div>
        <div class="vs">${scoreContent}</div>
        <div class="team">
          <img src="https://www.yalla-shoot-365.com${match['Team-Right'].Logo}" alt="${rightTeamName}">
          <span>${rightTeamName}</span>
        </div>
      </div>
      <div class="match-time">${new Date(match['Time-Start']).toLocaleTimeString()} - ${match['Match-Status']}</div>
    `;
    matchesContainer.appendChild(card);
  });
}

// تحميل مباريات اليوم تلقائي عند فتح الصفحة
fetchMatches('today');

</script>

<style>
.matches-wrapper { margin: 20px 0; }
.matches-container {
  display: flex;
  overflow-x: auto;
  gap: 10px;
  padding: 10px 0;
}
.matches-container {
    overflow-x: auto;  
    overflow-y: hidden;
    margin-bottom: -15px; 
}
.matches-container::-webkit-scrollbar {
    height: 2px;    
    width: 0px;    
}
.matches-container::-webkit-scrollbar-thumb {
    background: var(--accent);
    border-radius: 3px;
}


.match-card {
  background: var(--card);
  border-radius: 12px;
  box-shadow: 0 3px 6px rgba(0,0,0,0.2);
  width: 225px;
  padding: 5px;
  height: 120px;
  flex: 0 0 auto;
  display: flex;
  flex-direction: column;
  align-items: center;
  color: var(--text);
}
.league-name { font-weight: bold; font-size: 14px; margin-bottom: 8px; text-align: center; }
.teams { display: flex; justify-content: space-between; width: 100%; align-items: center; margin-bottom: 8px; }
.team { display: flex; flex-direction: column; align-items: center; width: 40%; }
.team img { width: 40px; height: 40px; margin-bottom: 3px; object-fit: contain; }
.vs { font-weight: bold; font-size: 16px; }
.match-time { font-size: 12px; color: var(--muted); }
.blinking { color: var(--Primary-A-Color); animation: blink 1s infinite; }
@keyframes blink { 0%,100%{opacity:1}50%{opacity:0} }
.buttons { margin-top: -55px; display: flex; justify-content: center; margin-bottom: -2px; gap: 7px; }
.buttons button { padding: 4px 6px; 
font-size: 11px; border-radius: 5px; border: none; cursor: pointer; background: #0d1b3d; color: #fff; font-weight: 600; }
.buttons button:hover { opacity: 0.85; }
}

</style>

<style>
  .dragon-footer {
      width: 100%;
      background: rgba(17, 17, 17, 0.75); 
      text-align: center;
      padding: 1px 0;
      position: fixed;
      bottom: 0px; /* حتى لا يتداخل مع الـ bottom-navbar */
      left: 0;
      color: #eee;
      font-size: 13px;
      z-index: 999;
      border-top: 1px solid #333;
  }
  .dragon-footer a {
      color: #37702c;
      font-weight: 600;
      text-decoration: none;
  }
  .dragon-footer a:hover {
      opacity: 0.8;
  }
</style>
</body>
</html>